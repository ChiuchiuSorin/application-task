<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>TasksCode</web>
  <name>NewTaskGroup</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>TaskCode.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1201258002000</creationDate>
  <date>1205367908000</date>
  <contentUpdateDate>1205367908000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/1.0</syntaxId>
  <hidden>false</hidden>
  <object>
    <class>
      <name>XWiki.TagClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <tags>
        <cache>0</cache>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>tags</name>
        <number>1</number>
        <prettyName>Tags</prettyName>
        <relationalStorage>1</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <values/>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </tags>
    </class>
    <name>TasksCode.NewTaskGroup</name>
    <number>0</number>
    <className>XWiki.TagClass</className>
    <guid>db215cc3-137d-4ad4-bee0-1d6e5dafc3f6</guid>
    <property>
      <tags/>
    </property>
  </object>
  <content>&lt;style&gt;
#includeInContext("TasksCode.Skin")
&lt;/style&gt;
#set($sql = "select max(prop.value)+1 from BaseObject as obj, IntegerProperty as prop where obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='id'")
#set($id = $xwiki.search($sql).get(0))
#if(!$id)
#set($id = 1)
#end
#if($request.page&amp;&amp;($request.page!=""))
#set($newTaskDoc = $xwiki.getDocument("${request.page}TaskGroup${id}"))
#else
#set($newTaskDoc = $xwiki.getDocument("TaskGroup${id}"))
#end
#if($request.assignees)
#set($notif = $xwiki.parseGroovyFromPage("TasksCode.TasksNotifications"))
#set($ok = $notif.setContext($context,$xwiki))
#set($ok = $newTaskDoc.newObject("TasksCode.IssueClass"))
#set($ok = $newTaskDoc.updateObjectFromRequest("TasksCode.IssueClass"))
#set($ok = $newTaskDoc.use("TasksCode.IssueClass"))
$newTaskDoc.set("id", $id)
$newTaskDoc.set("status", "new")
$newTaskDoc.set("resolution", "none")
$newTaskDoc.set("reporter", $context.localUser)
$newTaskDoc.set("taskgroup", "1")
$newTaskDoc.setContent($xwiki.getDocument("TasksCode.IssueClassTemplate").content)
$newTaskDoc.save()
$notif.sendNotification($newTaskDoc, "create")

$msg.get("its_taskgroup_created", [$newTaskDoc.display("title"),$newTaskDoc.fullName])

#set($assignees = $request.assignees.split(","))
#set($subtaskid = $id)
#foreach($assignee in $assignees)
#if($assignee!="")
#set($subtaskid = 1 + $subtaskid)
#if($request.page&amp;&amp;($request.page!=""))
#set($newSubTaskDoc = $xwiki.getDocument("${request.page}Task${subtaskid}"))
#else
#set($newSubTaskDoc = $xwiki.getDocument("Task${subtaskid}"))
#end
$newSubTaskDoc.use($newSubTaskDoc.newObject("TasksCode.IssueClass"))
#set($subtasktitle = $request.get("assignee_${assignee}"))
$newSubTaskDoc.set("id", $subtaskid)
$newSubTaskDoc.set("status", "new")
$newSubTaskDoc.set("resolution", "none")
$newSubTaskDoc.set("reporter", $context.localUser)
$newSubTaskDoc.set("taskgroup", "0")
$newSubTaskDoc.set("assignee", $assignee)
$newSubTaskDoc.set("title", $subtasktitle)
$newSubTaskDoc.set("description", "")
$newSubTaskDoc.set("dueDate", $newTaskDoc.getValue("dueDate"))
$newSubTaskDoc.set("severity", $newTaskDoc.getValue("severity"))
$newSubTaskDoc.set("page", $newTaskDoc.fullName)
$newSubTaskDoc.setContent($xwiki.getDocument("TasksCode.IssueClassTemplate").content)
$newSubTaskDoc.save()
$notif.sendNotification($newSubTaskDoc, "create")
$msg.get("its_taskgroup_created_subtask", [$newSubTaskDoc.display("title"),$newSubTaskDoc.fullName,$newSubTaskDoc.getValue("assignee")])
#end
#end

$msg.its_taskgroup_created_endmessage 
#else
$newTaskDoc.use($newTaskDoc.getObject("TasksCode.IssueClass", true))
$newTaskDoc.set("status", "new")
$newTaskDoc.set("resolution", "none")
$newTaskDoc.set("severity", "major")
$newTaskDoc.set("reporter", $context.localUser)
$newTaskDoc.set("assignee", $context.localUser)
$newTaskDoc.set("dueDate", "01/01/2008")
$newTaskDoc.set("taskgroup", "1")
#if($request.page)
$newTaskDoc.set("page", $request.page)
#else
$newTaskDoc.set("page", "Tasks.WebHome")
#end
#set($pagedoc = $xwiki.getDocument($doc.getValue("page")))
1 $msg.its_taskgroup_title #if($request.page) $msg.its_taskgroup_onpage [$pagedoc.displayTitle&gt;$pagedoc.fullName] #end

&lt;form action="" method="get" onsubmit="return updateAssignees(this);"&gt;
$newTaskDoc.display("page", "hidden")

&lt;div class="box" id="task"&gt;

1.1 $msg.its_taskgroup_newtask $newTaskDoc.display("title", "edit")

&lt;table&gt;
&lt;tr&gt;&lt;td&gt; $msg.its_task_reporter : &lt;/td&gt;&lt;td&gt; $newTaskDoc.display("reporter", "view") &lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;$msg.its_task_assignee : &lt;/td&gt;&lt;td&gt; $newTaskDoc.display("assignee", "edit") &lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;$msg.its_task_dueDate : &lt;/td&gt;&lt;td&gt; $newTaskDoc.display("dueDate", "edit") &lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;$msg.its_task_severity : &lt;/td&gt;&lt;td&gt; $newTaskDoc.display("severity", "edit") &lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;

&lt;fieldset&gt;
&lt;legend class="fieldset"&gt;$msg.its_task_description&lt;/legend&gt;

$newTaskDoc.display("description", "edit")
&lt;/fieldset&gt;
&lt;fieldset&gt;
&lt;legend class="fieldset"&gt;$msg.its_taskgroup_subtasks&lt;/legend&gt;
$msg.its_taskgroup_subtaskexplanation &lt;br /&gt;
{pre}
&lt;script type="text/javascript"&gt;
var currentUsers = {};
function addUser(user, userprettyname, title) {
 if (currentUsers[user]&amp;&amp;currentUsers[user]=="1") {
   alert("already added");
 } else {
  //  alert(user);
  if (!$(user)) {
  userel = document.createElement("div");
  userel.id = user;
  userel.innerHTML = getAssigneeHTML(user, userprettyname, title);
  $("subtasksassignees").appendChild(userel);
  } else {
   $(user).innerHTML = getAssigneeHTML(user, userprettyname, title);
  }
  currentUsers[user] = "1";
 }
}
function getAssigneeHTML(user, userprettyname, title) {
 return "&lt;div class'subtaskline'&gt;&lt;div class'subtaskname'&gt;" + userprettyname + "&lt;/div&gt;&lt;div class'subtaskfield'&gt;"
   + "&lt;input type=\"text\" size=\"60\" id=\"assignee_" + user + "\" name=\"assignee_" + user + "\" value=\"" + title + "\" /&gt;&lt;/div&gt;&lt;div class'subtaskremove'&gt;"
   + "&lt;a href=\"javascript:void()\" onclick=\"removeUser('" + user + "'); return false;\"&gt;remove&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;";
}
function removeUser(user) {
 if (currentUsers[user]) {
   currentUsers[user] = "0";
   $(user).innerHTML = "";  
 }
}
function updateAssignees(form) {
 var assignees = "";
 var title = form['TasksCode.IssueClass_0_title'].value;
 if (title=="") {
   alert('$msg.its_taskgroup_titlemissing');
   return false;
 }
 for(user in currentUsers) {
   if (currentUsers[user]=="1") {
     if (assignees=="")
      assignees = user;
     else
      assignees = assignees + "," + user; 

     var field = form['assignee_' + user];
     if (field.value=="")
      field.value = title;
   }
 }
 form.assignees.value = assignees;
 return true;
}
function getPrettyName(selectField) {
  return selectField.options[selectField.selectedIndex].text;
}
&lt;/script&gt;
&lt;input type="hidden" name="assignees" value="" /&gt;
&lt;select style="margin-top: 8px; margin-bottom: 8px;" id="subtasksassignee" onchange="addUser(this.value, getPrettyName(this), this.form['TasksCode.IssueClass_0_title'].value);"&gt;
&lt;option value=""&gt;$msg.its_taskgroup_addsubtaskassignee&lt;/option&gt;
#set($sql = ",BaseObject as obj where doc.fullName=obj.name and obj.className='XWiki.XWikiUsers'") 
#foreach($item in $xwiki.searchDocuments($sql))
#set($itemdoc = $xwiki.getDocument($item))
&lt;option value="$item"&gt;$itemdoc.first_name $itemdoc.last_name&lt;/option&gt;
#end
&lt;/select&gt;
{/pre}
&lt;div id="subtasksassignees"&gt;
&lt;/div&gt;
&lt;/fieldset&gt;
 &lt;input type="submit" value="$msg.its_taskgroup_createsubtasks" /&gt;
&lt;div class="clearfloats"&gt;&lt;br /&gt;&lt;/div&gt;
&lt;/form&gt;
&lt;/div&gt;
#end
#set($showcomments = "no")
#set($showattachments = "no")</content>
</xwikidoc>
