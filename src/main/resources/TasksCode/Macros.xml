<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>TasksCode</web>
  <name>Macros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>TaskCode.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1200842959000</creationDate>
  <date>1205434383000</date>
  <contentUpdateDate>1205434383000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/1.0</syntaxId>
  <hidden>false</hidden>
  <object>
    <class>
      <name>XWiki.TagClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <tags>
        <cache>0</cache>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>tags</name>
        <number>1</number>
        <prettyName>Tags</prettyName>
        <relationalStorage>1</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <values/>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </tags>
    </class>
    <name>TasksCode.Macros</name>
    <number>0</number>
    <className>XWiki.TagClass</className>
    <guid>9817dd62-a810-4853-b2d1-9faaf33bad77</guid>
    <property>
      <tags/>
    </property>
  </object>
  <content>&lt;style&gt;
#includeInContext("TasksCode.Skin")
&lt;/style&gt;

#includeMacros("GWT.GWTPropEditor")

## macros

#macro(tasksbydoc $docName)
#foreach($taskDocName in $xwiki.searchDocuments(", BaseObject as obj, StringProperty as prop where doc.fullName=obj.name and obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='page' and prop.value='${docName}' order by doc.date desc"))
#set($taskdoc = $xwiki.getDocument($taskDocName))
#set($ok = $taskdoc.use("TasksCode.IssueClass"))
&lt;fieldset&gt;
&lt;legend class="fieldset"&gt;[$msg.its_task $taskdoc.display("id")&gt;$taskDocName] - [$taskdoc.display("title")&gt;$taskDocName]&lt;/legend&gt; 
* $msg.its_task_status : $taskdoc.display("status")
* $msg.its_task_assignee : $xwiki.getLocalUserName($taskdoc.display("assignee"))

$taskdoc.display("description")
&lt;/fieldset&gt;
#end
#end

#macro(tasksbydocpanel $docName)
#set($pagetasks = $xwiki.searchDocuments(", BaseObject as obj, StringProperty as prop where doc.fullName=obj.name and obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='page' and prop.value='${docName}' order by doc.date desc"))
#if($pagetasks.size() &gt; 0)
#foreach($taskDocName in $pagetasks)
#set($taskdoc = $xwiki.getDocument($taskDocName))
#set($ok = $taskdoc.use("TasksCode.IssueClass"))
&lt;div&gt;
&lt;span style="font-size: 1.2em;"&gt;[$msg.its_task $taskdoc.display("id","view")&gt;$taskDocName] - [$taskdoc.display("title","view")&gt;$taskDocName]&lt;/span&gt;
* $msg.its_task_status : $taskdoc.display("status","view")
* $msg.its_task_assignee : $xwiki.getLocalUserName($taskdoc.display("assignee","view"))
&lt;/div&gt;
#end
#else
$msg.its_pagetasks_notask
#end
#end

#macro(mytaskspanel)
#set($mytasks = $xwiki.searchDocuments(",BaseObject as obj, StringProperty as prop, StringProperty as statusprop where doc.fullName=obj.name and obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='assignee' and prop.value='${context.localUser}' and obj.id=statusprop.id.id and statusprop.id.name='status' and statusprop.value in ('new','open','reopened') order by doc.date desc", 5, 0))
#if($mytasks.size() &gt; 0)
#foreach($taskDocName in $mytasks)
#set($taskdoc = $xwiki.getDocument($taskDocName))
#set($ok = $taskdoc.use("TasksCode.IssueClass"))
&lt;div&gt;
&lt;span style="font-size: 1.2em;"&gt; [$msg.its_task $taskdoc.display("id", "view")&gt;$taskDocName] - [$taskdoc.display("title", "view")&gt;$taskDocName] &lt;/span&gt;
* $msg.its_task_status : $taskdoc.display("status", "view")
* $msg.its_task_assignee : $xwiki.getUserName($taskdoc.display("assignee", "view"))
&lt;/div&gt;
#end
#else
$msg.its_mytasks_notask
#end
#end

#macro(mytasksbyspacepanel $space)
#foreach($taskDocName in $xwiki.searchDocuments(",BaseObject as obj, StringProperty as prop, StringProperty as statusprop where doc.fullName=obj.name and obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='assignee' and prop.value='${context.localUser}' and doc.web='${space}' and obj.id=statusprop.id.id and statusprop.id.name='status' and statusprop.value in ('new','open','reopened') order by doc.date desc"))
#set($taskdoc = $xwiki.getDocument($taskDocName))
#set($ok = $taskdoc.use("TasksCode.IssueClass"))
&lt;div style="margin: 5px;"&gt;
&lt;span style="font-size: 1.2em;"&gt; [$msg.its_task $taskdoc.display("id", "view")&gt;$taskDocName] - [$taskdoc.display("title", "view")&gt;$taskDocName] &lt;/span&gt;
* $msg.its_task_status : $taskdoc.display("status", "view")
* $msg.its_task_assignee : $xwiki.getUserName($taskdoc.display("assignee", "view"))
&lt;/div&gt;
#end
#end

#macro(mytasks)
#tasksbyspace($context.localUser "")
#end 

#macro(crmtasks $user)
#tasksbyspace($user "CRM")
#end 

#macro(tasks $assignee) 
#tasksbyspace($assignee "")
#end

#macro(tasksbyspace $assignee $space) 
&lt;table id="searchTableTasks" class="grid sortable filterable doOddEven" cellSpacing=0 cellpadding="0" border="1"&gt;
&lt;tr class="sortHeader"&gt;
&lt;th&gt; $msg.its_task_id &lt;/th&gt;
&lt;th&gt; $msg.its_task_title &lt;/th&gt;
&lt;th&gt; $msg.its_task_assignee &lt;/th&gt;
&lt;th&gt; $msg.its_task_status &lt;/th&gt;
&lt;th&gt; $msg.its_task_severity &lt;/th&gt;
&lt;/tr&gt;
#if($space=="")
#set($sql = ",BaseObject as obj, StringProperty as prop, StringProperty as statusprop where doc.fullName=obj.name and obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='assignee' and prop.value='${assignee}' and obj.id=statusprop.id.id and statusprop.id.name='status' and statusprop.value in ('new','open','reopened') order by doc.date desc")
#else
#set($sql = ",BaseObject as obj, StringProperty as prop, StringProperty as statusprop where doc.fullName=obj.name and obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='assignee' and prop.value='${assignee}' and doc.web='${space}' and obj.id=statusprop.id.id and statusprop.id.name='status' and statusprop.value in ('new','open','reopened') order by doc.date desc")
#end
#foreach($taskDocName in $xwiki.searchDocuments($sql))
#set($taskdoc = $xwiki.getDocument($taskDocName))
#set($classname = "TasksCode.IssueClass")
#set($ok = $taskdoc.use("TasksCode.IssueClass"))
&lt;tr&gt;
&lt;td&gt; [$msg.its_task $taskdoc.display("id")&gt;$taskDocName] &lt;/td&gt;
&lt;td&gt; [$taskdoc.display("title")&gt;$taskDocName] &lt;/td&gt;
#display($taskdoc $classname "assignee" "")
#display($taskdoc $classname "status" "")
#display($taskdoc $classname "severity" "")
&lt;/tr&gt;
#end
&lt;/table&gt;
#end

#macro(myreportedtasks)
#reportedtasks($context.localUser)
#end 

#macro(reportedtasks $reporter) 
&lt;table id="searchTableReportedTasks" class="grid sortable filterable doOddEven" cellSpacing=0 cellpadding="0" border="1"&gt;
&lt;tr class="sortHeader"&gt;
&lt;th&gt; $msg.its_task_id &lt;/th&gt;
&lt;th&gt; $msg.its_task_title &lt;/th&gt;
&lt;th&gt; $msg.its_task_assignee &lt;/th&gt;
&lt;th&gt; $msg.its_task_status &lt;/th&gt;
&lt;th&gt; $msg.its_task_severity &lt;/th&gt;
&lt;/tr&gt;
#foreach($taskDocName in $xwiki.searchDocuments(",BaseObject as obj, StringProperty as prop where doc.fullName=obj.name and obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='reporter' and prop.value='${reporter}' order by doc.date desc"))
#set($taskdoc = $xwiki.getDocument($taskDocName))
#set($classname = "TasksCode.IssueClass")
#set($ok = $taskdoc.use("TasksCode.IssueClass"))
&lt;tr&gt;
&lt;td&gt; [$msg.its_task $taskdoc.display("id")&gt;$taskDocName] &lt;/td&gt;
&lt;td&gt; [$taskdoc.display("title")&gt;$taskDocName] &lt;/td&gt;
#display($taskdoc $classname "assignee" "")
#display($taskdoc $classname "status" "")
#display($taskdoc $classname "severity" "")
&lt;/tr&gt;
#end
&lt;/table&gt;
#end


#macro(activetasks) 
&lt;table id="searchTableActiveTasks" class="grid sortable filterable doOddEven" cellSpacing=0 cellpadding="0" border="1"&gt;
&lt;tr class="sortHeader"&gt;
&lt;th&gt; $msg.its_task_id &lt;/th&gt;
&lt;th&gt; $msg.its_task_title &lt;/th&gt;
&lt;th&gt; $msg.its_task_assignee &lt;/th&gt;
&lt;th&gt; $msg.its_task_status &lt;/th&gt;
&lt;th&gt; $msg.its_task_severity &lt;/th&gt;
&lt;/tr&gt;
#foreach($taskDocName in $xwiki.searchDocuments(",BaseObject as obj, StringProperty as prop where doc.fullName=obj.name and obj.className='TasksCode.IssueClass' and obj.id=prop.id.id and prop.id.name='status' and prop.value in ('new','open','reopened') and doc.fullName&lt;&gt;'TasksCode.TasksClassTemplate' and doc.fullName&lt;&gt;'TasksCode.IssueClassTemplate' order by doc.date desc", 20, 0))
#set($taskdoc = $xwiki.getDocument($taskDocName))
#set($classname = "TasksCode.IssueClass")
#set($ok = $taskdoc.use("$classname"))
&lt;tr&gt;
&lt;td&gt; [$msg.its_task $taskdoc.display("id")&gt;$taskDocName] &lt;/td&gt;
&lt;td&gt; [$taskdoc.display("title")&gt;$taskDocName] &lt;/td&gt;
#display($taskdoc $classname "assignee" "")
#display($taskdoc $classname "status" "")
#display($taskdoc $classname "severity" "")
&lt;/tr&gt;
#end
&lt;/table&gt;
#end</content>
</xwikidoc>
